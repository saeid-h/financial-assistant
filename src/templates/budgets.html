{% extends "base.html" %}

{% block title %}Budgets - Financial Assistant{% endblock %}

{% block content %}
<div class="budgets-page">
    <div class="page-header">
        <h1>Budget Management</h1>
        <button id="add-budget-btn" class="btn btn-primary">+ Add Budget</button>
    </div>
    
    <!-- Summary Cards -->
    <div class="budget-summary">
        <div class="summary-card">
            <div class="summary-label">Total Budgeted</div>
            <div class="summary-value" id="total-budgeted">$0.00</div>
        </div>
        <div class="summary-card">
            <div class="summary-label">Total Spent</div>
            <div class="summary-value" id="total-spent">$0.00</div>
        </div>
        <div class="summary-card">
            <div class="summary-label">Remaining</div>
            <div class="summary-value" id="total-remaining">$0.00</div>
        </div>
        <div class="summary-card alert">
            <div class="summary-label">⚠️ Over Budget</div>
            <div class="summary-value" id="over-budget-count">0</div>
        </div>
    </div>
    
    <!-- Budgets List -->
    <div id="budgets-container">
        <div id="budgets-loading" class="loading">Loading budgets...</div>
        <div id="budgets-list"></div>
        <div id="no-budgets" class="empty-state" style="display: none;">
            <p>No budgets set for this month.</p>
            <button class="btn btn-primary" onclick="document.getElementById('add-budget-btn').click()">
                Create Your First Budget
            </button>
        </div>
    </div>
</div>

<!-- Add/Edit Budget Modal -->
<div id="budget-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">Add Budget</h2>
            <button class="close-btn" onclick="closeBudgetModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="budget-form">
                <input type="hidden" id="budget-id">
                
                <div class="form-group">
                    <label for="category-select">Category *</label>
                    <select id="category-select" class="form-control" required>
                        <option value="">Select a category...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="amount-input">Monthly Budget Amount *</label>
                    <input type="number" id="amount-input" class="form-control" 
                           placeholder="0.00" step="0.01" min="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="alert-threshold">Alert Threshold (%)</label>
                    <input type="range" id="alert-threshold" class="form-range" 
                           min="50" max="100" value="80" step="5">
                    <span id="threshold-display">80%</span>
                    <small>Alert when spending reaches this percentage</small>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeBudgetModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Budget</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.budgets-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 30px;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.budget-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.summary-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    text-align: center;
}

.summary-card.alert {
    background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
    border: 2px solid #dc3545;
}

.summary-label {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 10px;
}

.summary-value {
    font-size: 2rem;
    font-weight: 700;
    color: #333;
}

#budgets-list {
    display: grid;
    gap: 20px;
}

.budget-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.budget-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.budget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.budget-category {
    font-size: 1.3rem;
    font-weight: 600;
    color: #333;
}

.budget-actions {
    display: flex;
    gap: 10px;
}

.budget-amounts {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 0.9rem;
}

.budget-progress-bar {
    height: 30px;
    background: #f0f0f0;
    border-radius: 15px;
    overflow: hidden;
    margin-bottom: 10px;
    position: relative;
}

.budget-progress-fill {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    transition: width 0.3s;
}

.budget-progress-fill.good {
    background: linear-gradient(90deg, #28a745, #20c997);
}

.budget-progress-fill.warning {
    background: linear-gradient(90deg, #ffc107, #ff9800);
}

.budget-progress-fill.over {
    background: linear-gradient(90deg, #dc3545, #c82333);
}

.budget-status {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.budget-status.good {
    background: #d4edda;
    color: #155724;
}

.budget-status.warning {
    background: #fff3cd;
    color: #856404;
}

.budget-status.over {
    background: #f8d7da;
    color: #721c24;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 10px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.form-group small {
    display: block;
    color: #666;
    font-size: 0.85rem;
    margin-top: 5px;
}

.form-range {
    width: 100%;
    margin: 10px 0;
}

#threshold-display {
    display: inline-block;
    min-width: 50px;
    text-align: center;
    font-weight: 600;
    color: #667eea;
}

.form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
}
</style>

<script>
let currentBudgets = [];

// Format currency
function formatCurrency(amount) {
    return '$' + Math.abs(amount).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Load budgets
async function loadBudgets() {
    const loading = document.getElementById('budgets-loading');
    const list = document.getElementById('budgets-list');
    const noBudgets = document.getElementById('no-budgets');
    
    loading.style.display = 'block';
    list.style.display = 'none';
    noBudgets.style.display = 'none';
    
    try {
        const response = await fetch('/budgets/api/');
        const data = await response.json();
        
        loading.style.display = 'none';
        
        if (!data.success) {
            throw new Error(data.error);
        }
        
        currentBudgets = data.budgets;
        
        // Update summary
        if (data.summary) {
            document.getElementById('total-budgeted').textContent = formatCurrency(data.summary.total_budgeted);
            document.getElementById('total-spent').textContent = formatCurrency(data.summary.total_actual);
            document.getElementById('total-remaining').textContent = formatCurrency(data.summary.total_remaining);
            document.getElementById('over-budget-count').textContent = data.summary.over_budget_count;
        }
        
        if (currentBudgets.length === 0) {
            noBudgets.style.display = 'block';
            return;
        }
        
        // Render budgets
        list.innerHTML = currentBudgets.map(budget => `
            <div class="budget-card">
                <div class="budget-header">
                    <div class="budget-category">${budget.category_name}</div>
                    <div class="budget-actions">
                        <span class="budget-status ${budget.status}">${budget.status}</span>
                        <button class="btn btn-sm btn-secondary" onclick="editBudget(${budget.budget_id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBudget(${budget.budget_id})">Delete</button>
                    </div>
                </div>
                <div class="budget-amounts">
                    <span>Budgeted: ${formatCurrency(budget.budgeted)}</span>
                    <span>Spent: ${formatCurrency(budget.actual)}</span>
                    <span>Remaining: ${formatCurrency(budget.remaining)}</span>
                </div>
                <div class="budget-progress-bar">
                    <div class="budget-progress-fill ${budget.status}" style="width: ${Math.min(budget.percentage, 100)}%">
                        ${budget.percentage.toFixed(1)}%
                    </div>
                </div>
                ${budget.alert ? '<div style="color: #dc3545; font-size: 0.9rem; margin-top: 10px;">⚠️ Alert: Approaching budget limit!</div>' : ''}
            </div>
        `).join('');
        
        list.style.display = 'block';
        
    } catch (error) {
        loading.style.display = 'none';
        alert('Error loading budgets: ' + error.message);
    }
}

// Load categories for dropdown
async function loadCategories() {
    try {
        const response = await fetch('/categories/api/all');
        const data = await response.json();
        
        const select = document.getElementById('category-select');
        // Clear existing options except first
        while (select.options.length > 1) {
            select.remove(1);
        }
        
        // Only show expense categories (level 1)
        const expenseCategories = data.categories.filter(c => c.type === 'expense' && c.level === 1);
        expenseCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// Open add budget modal
document.getElementById('add-budget-btn').addEventListener('click', () => {
    document.getElementById('modal-title').textContent = 'Add Budget';
    document.getElementById('budget-form').reset();
    document.getElementById('budget-id').value = '';
    
    // Set current month dates
    const today = new Date();
    const start = new Date(today.getFullYear(), today.getMonth(), 1);
    const end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    document.getElementById('budget-modal').classList.add('active');
});

// Close modal
function closeBudgetModal() {
    document.getElementById('budget-modal').classList.remove('active');
}

// Edit budget
function editBudget(budgetId) {
    const budget = currentBudgets.find(b => b.budget_id === budgetId);
    if (!budget) return;
    
    document.getElementById('modal-title').textContent = 'Edit Budget';
    document.getElementById('budget-id').value = budget.budget_id;
    document.getElementById('category-select').value = budget.category_id;
    document.getElementById('amount-input').value = budget.budgeted;
    document.getElementById('alert-threshold').value = 80; // Default, we'd need to store this
    
    document.getElementById('budget-modal').classList.add('active');
}

// Delete budget
async function deleteBudget(budgetId) {
    if (!confirm('Are you sure you want to delete this budget?')) return;
    
    try {
        const response = await fetch(`/budgets/api/${budgetId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        if (data.success) {
            loadBudgets();
        } else {
            alert('Failed to delete budget');
        }
    } catch (error) {
        alert('Error deleting budget: ' + error.message);
    }
}

// Save budget
document.getElementById('budget-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const budgetId = document.getElementById('budget-id').value;
    const categoryId = document.getElementById('category-select').value;
    const amount = document.getElementById('amount-input').value;
    const alertThreshold = document.getElementById('alert-threshold').value;
    
    // Calculate current month dates
    const today = new Date();
    const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
    const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    const budgetData = {
        category_id: parseInt(categoryId),
        amount: parseFloat(amount),
        period_type: 'monthly',
        start_date: startDate.toISOString().split('T')[0],
        end_date: endDate.toISOString().split('T')[0],
        alert_threshold: parseInt(alertThreshold)
    };
    
    try {
        const url = budgetId ? `/budgets/api/${budgetId}` : '/budgets/api/create';
        const method = budgetId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(budgetData)
        });
        
        const data = await response.json();
        if (data.success) {
            closeBudgetModal();
            loadBudgets();
        } else {
            alert('Failed to save budget: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error saving budget: ' + error.message);
    }
});

// Update threshold display
document.getElementById('alert-threshold').addEventListener('input', (e) => {
    document.getElementById('threshold-display').textContent = e.target.value + '%';
});

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadCategories();
    loadBudgets();
});
</script>
{% endblock %}

