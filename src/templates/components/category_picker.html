<!-- Category Picker Popover Component -->
<div id="category-picker-modal" class="category-picker-overlay">
    <div class="modal-content category-picker-content" id="category-picker-content">
        <div class="modal-header">
            <h2>Select Category</h2>
            <button class="close-btn" onclick="closeCategoryPicker()">&times;</button>
        </div>
        
        <div class="category-picker-body">
            <!-- Breadcrumb -->
            <div id="category-breadcrumb" class="breadcrumb"></div>
            
            <!-- Main category selection area -->
            <div class="category-columns">
                <div class="category-column" id="level-1-column">
                    <div class="column-title">Category Type</div>
                    <div class="category-list" id="level-1-list"></div>
                </div>
                
                <div class="category-column" id="level-2-column" style="display: none;">
                    <div class="column-title" id="level-2-title">Subcategory</div>
                    <div class="category-list" id="level-2-list"></div>
                </div>
                
                <div class="category-column" id="level-3-column" style="display: none;">
                    <div class="column-title" id="level-3-title">Detail</div>
                    <div class="category-list" id="level-3-list"></div>
                </div>
            </div>
            
            <!-- Learning Option -->
            <div class="learning-option">
                <label>
                    <input type="checkbox" id="learn-checkbox" checked>
                    ðŸ§  Remember this for similar transactions (creates auto-categorization rule)
                </label>
            </div>
            
            <!-- Actions -->
            <div class="picker-actions">
                <button class="btn btn-secondary" onclick="closeCategoryPicker()">Cancel</button>
                <button class="btn btn-warning" onclick="selectUncategorized()">
                    âœ— Clear Category
                </button>
                <button class="btn btn-success" id="assign-category-btn" onclick="assignSelectedCategory()" disabled>
                    âœ“ Assign Category
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.category-picker-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.3);
    z-index: 1000;
    animation: fadeInBg 0.2s ease-out;
}

.category-picker-overlay.active {
    display: block;
}

@keyframes fadeInBg {
    from { opacity: 0; }
    to { opacity: 1; }
}

.category-picker-content {
    position: fixed;
    max-width: 650px;
    width: 650px;
    max-height: 500px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.25), 0 2px 8px rgba(0,0,0,0.1);
    z-index: 1001;
    display: flex;
    flex-direction: column;
    animation: slideUp 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(102, 126, 234, 0.1);
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.category-picker-body {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.breadcrumb {
    padding: 12px 20px;
    background: linear-gradient(to right, #f8f9fa, #e8f0fe);
    border-bottom: 1px solid #e0e0e0;
    font-size: 0.9em;
    color: #667eea;
    min-height: 20px;
    font-weight: 500;
}

.breadcrumb .separator {
    margin: 0 10px;
    color: #667eea;
    opacity: 0.6;
}

.category-columns {
    display: flex;
    gap: 1px;
    flex: 1;
    min-height: 200px;
    background: #e0e0e0;
}

.category-column {
    flex: 1;
    background: white;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.column-title {
    background: #f8f9fa;
    color: #667eea;
    padding: 10px;
    font-weight: 700;
    font-size: 0.75em;
    text-align: center;
    border-bottom: 2px solid #667eea;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    flex-shrink: 0;
}

.category-list {
    flex: 1;
    overflow-y: auto;
    min-height: 0;
    max-height: 100%;
    scrollbar-width: thin;
    scrollbar-color: #667eea #f0f0f0;
    -webkit-overflow-scrolling: touch;
}

.category-list::-webkit-scrollbar {
    width: 6px;
}

.category-list::-webkit-scrollbar-track {
    background: #f0f0f0;
}

.category-list::-webkit-scrollbar-thumb {
    background: #667eea;
    border-radius: 3px;
}

.category-list::-webkit-scrollbar-thumb:hover {
    background: #5568d3;
}

.category-option {
    padding: 10px 14px;
    cursor: pointer;
    border-bottom: 1px solid #f5f5f5;
    transition: all 0.15s;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9em;
}

.category-option:hover {
    background: #f8f9fa;
    padding-left: 20px;
}

.category-option.selected {
    background: linear-gradient(to right, #e8f0fe, #f8f9fa);
    border-left: 4px solid #667eea;
    padding-left: 16px;
    font-weight: 600;
    color: #667eea;
}

.category-option.has-children::after {
    content: 'â€º';
    color: #bbb;
    font-size: 1.4em;
    font-weight: 300;
}

.category-option.new-category {
    color: #667eea;
    font-weight: 700;
    border-bottom: 2px solid #667eea;
    background: linear-gradient(135deg, #f8f9ff 0%, #e8f0fe 100%);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
    margin: 0;
    padding: 12px 14px;
    position: sticky;
    top: 0;
    z-index: 10;
}

.category-option.new-category:hover {
    background: linear-gradient(135deg, #e8f0fe 0%, #d0e0ff 100%);
    box-shadow: 0 2px 12px rgba(102, 126, 234, 0.25);
    transform: scale(1.02);
}

.category-badge {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: 700;
    box-shadow: 0 2px 4px rgba(39, 174, 96, 0.2);
}

.learning-option {
    padding: 12px 20px;
    background: linear-gradient(135deg, #fff8e1 0%, #fffbea 100%);
    border-top: 1px solid #ffe082;
    border-bottom: 1px solid #ffe082;
}

.learning-option label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 0.85em;
    color: #5d4037;
    font-weight: 500;
}

.learning-option input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #667eea;
}

.picker-actions {
    padding: 15px 20px;
    background: #fafbfc;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.picker-actions .btn {
    padding: 8px 16px;
    font-weight: 600;
    min-width: 100px;
    font-size: 0.9em;
}

.btn-warning {
    background: #ff9800;
    color: white;
}

.btn-warning:hover {
    background: #f57c00;
}

@media (max-width: 768px) {
    .category-columns {
        flex-direction: column;
    }
    
    .category-column {
        min-height: 200px;
    }
}
</style>

<script>
let currentTransaction = null;
let selectedCategoryPath = [];
let selectedCategoryId = null;
let allCategoriesForPicker = [];

function openCategoryPicker(transactionId, buttonElement) {
    currentTransaction = transactionId;
    selectedCategoryPath = [];
    selectedCategoryId = null;
    
    console.log('openCategoryPicker called for transaction:', transactionId);
    
    // Load categories and show picker
    loadCategoriesForPicker().then(() => {
        showLevel1Categories();
        
        const overlay = document.getElementById('category-picker-modal');
        const content = document.getElementById('category-picker-content');
        
        overlay.classList.add('active');
        document.getElementById('assign-category-btn').disabled = true;
        
        // Position with FIXED - GUARANTEED to stay in viewport!
        if (buttonElement) {
            const rect = buttonElement.getBoundingClientRect();
            
            const pickerHeight = 500;
            const pickerWidth = 650;
            const gap = 10;
            const margin = 20;
            
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            
            let top, left;
            
            // STEP 1: Calculate ideal position (below or above button)
            const spaceBelow = viewportHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            // Prefer below, but use above if more space there
            if (spaceBelow >= spaceAbove) {
                // Try below
                top = rect.bottom + gap;
            } else {
                // Try above
                top = rect.top - pickerHeight - gap;
            }
            
            // STEP 2: FORCE into viewport bounds (this is the KEY fix!)
            const minTop = margin;
            const maxTop = viewportHeight - pickerHeight - margin;
            
            // If picker is too tall for viewport, center it
            if (maxTop < minTop) {
                top = (viewportHeight - pickerHeight) / 2;
            } else {
                // Clamp to valid range
                top = Math.max(minTop, Math.min(top, maxTop));
            }
            
            // STEP 3: Horizontal position
            left = rect.left - 280;
            left = Math.max(margin, Math.min(left, viewportWidth - pickerWidth - margin));
            
            content.style.top = top + 'px';
            content.style.left = left + 'px';
            content.style.transform = 'none';
        } else {
            // Center on screen if no button reference
            content.style.top = '50%';
            content.style.left = '50%';
            content.style.transform = 'translate(-50%, -50%)';
        }
    }).catch(error => {
        console.error('Error opening category picker:', error);
        alert('Error loading categories. Please try again.');
    });
}

function closeCategoryPicker() {
    const overlay = document.getElementById('category-picker-modal');
    overlay.classList.remove('active');
    
    currentTransaction = null;
    selectedCategoryPath = [];
    selectedCategoryId = null;
}

async function loadCategoriesForPicker() {
    try {
        const response = await fetch('/categories/api/all');
        const data = await response.json();
        
        if (data.success) {
            allCategoriesForPicker = data.categories;
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

function showLevel1Categories() {
    const level1Categories = allCategoriesForPicker.filter(c => c.level === 1);
    const list = document.getElementById('level-1-list');
    list.innerHTML = '';
    
    // Add "New Category Type" option FIRST (at top)
    const newDiv = document.createElement('div');
    newDiv.className = 'category-option new-category';
    newDiv.innerHTML = `<span>âž• Add New Category Type...</span>`;
    newDiv.onclick = () => promptNewCategory(null, 1);
    list.appendChild(newDiv);
    
    // Group by type
    const types = [
        { key: 'income', label: 'ðŸ’° Income', icon: 'ðŸ’°' },
        { key: 'expense', label: 'ðŸ’¸ Expenses', icon: 'ðŸ’¸' },
        { key: 'transfer', label: 'ðŸ’¹ Savings & Investments', icon: 'ðŸ’¹' }
    ];
    
    types.forEach(typeInfo => {
        const typeCats = level1Categories.filter(c => c.type === typeInfo.key);
        
        typeCats.forEach(cat => {
            const div = document.createElement('div');
            div.className = 'category-option has-children';
            div.innerHTML = `
                <span>${typeInfo.icon} ${cat.name}</span>
                <span class="category-badge">${cat.transaction_count || 0}</span>
            `;
            div.onclick = () => selectLevel1(cat);
            list.appendChild(div);
        });
    });
    
    // Hide level 2 and 3
    document.getElementById('level-2-column').style.display = 'none';
    document.getElementById('level-3-column').style.display = 'none';
    
    updateBreadcrumb();
}

function selectLevel1(category) {
    selectedCategoryPath = [category];
    
    // Show level 2 children
    const children = allCategoriesForPicker.filter(c => c.parent_id === category.id);
    
    if (children.length > 0) {
        showLevel2Categories(children);
        document.getElementById('level-2-column').style.display = 'block';
        document.getElementById('level-2-title').textContent = category.name;
    } else {
        // No children, can select this
        document.getElementById('level-2-column').style.display = 'none';
        document.getElementById('level-3-column').style.display = 'none';
    }
    
    updateBreadcrumb();
}

function showLevel2Categories(categories) {
    const list = document.getElementById('level-2-list');
    list.innerHTML = '';
    
    // Add "New..." option FIRST (at top)
    const newDiv = document.createElement('div');
    newDiv.className = 'category-option new-category';
    newDiv.innerHTML = `<span>âž• Add New ${selectedCategoryPath[0].name}...</span>`;
    newDiv.onclick = () => promptNewCategory(selectedCategoryPath[0].id, 2);
    list.appendChild(newDiv);
    
    categories.forEach(cat => {
        const div = document.createElement('div');
        const hasChildren = allCategoriesForPicker.some(c => c.parent_id === cat.id);
        div.className = `category-option ${hasChildren ? 'has-children' : ''}`;
        div.innerHTML = `
            <span>${cat.name}</span>
            <span class="category-badge">${cat.transaction_count || 0}</span>
        `;
        div.onclick = () => selectLevel2(cat);
        list.appendChild(div);
    });
    
    document.getElementById('level-3-column').style.display = 'none';
}

function selectLevel2(category) {
    selectedCategoryPath = [selectedCategoryPath[0], category];
    selectedCategoryId = category.id;
    
    // Highlight selection in level 2
    document.querySelectorAll('#level-2-list .category-option').forEach(el => {
        el.classList.remove('selected');
    });
    event.target.closest('.category-option').classList.add('selected');
    
    // Show level 3 children if they exist
    const children = allCategoriesForPicker.filter(c => c.parent_id === category.id);
    
    if (children.length > 0) {
        showLevel3Categories(children);
        document.getElementById('level-3-column').style.display = 'block';
        document.getElementById('level-3-title').textContent = category.name;
    } else {
        // No children, this is selectable
        document.getElementById('level-3-column').style.display = 'none';
    }
    
    // Enable assign button
    document.getElementById('assign-category-btn').disabled = false;
    updateBreadcrumb();
}

function showLevel3Categories(categories) {
    const list = document.getElementById('level-3-list');
    list.innerHTML = '';
    
    // Add "New..." option FIRST (at top)
    const newDiv = document.createElement('div');
    newDiv.className = 'category-option new-category';
    newDiv.innerHTML = `<span>âž• Add New ${selectedCategoryPath[1].name}...</span>`;
    newDiv.onclick = () => promptNewCategory(selectedCategoryPath[1].id, 3);
    list.appendChild(newDiv);
    
    categories.forEach(cat => {
        const div = document.createElement('div');
        div.className = 'category-option';
        div.innerHTML = `
            <span>${cat.name}</span>
            <span class="category-badge">${cat.transaction_count || 0}</span>
        `;
        div.onclick = () => selectLevel3(cat);
        list.appendChild(div);
    });
}

function selectLevel3(category) {
    selectedCategoryPath = [selectedCategoryPath[0], selectedCategoryPath[1], category];
    selectedCategoryId = category.id;
    
    // Highlight selection in level 3
    document.querySelectorAll('#level-3-list .category-option').forEach(el => {
        el.classList.remove('selected');
    });
    event.target.closest('.category-option').classList.add('selected');
    
    // Enable assign button
    document.getElementById('assign-category-btn').disabled = false;
    updateBreadcrumb();
}

function updateBreadcrumb() {
    const breadcrumb = document.getElementById('category-breadcrumb');
    
    if (selectedCategoryPath.length === 0) {
        breadcrumb.innerHTML = 'Select a category type...';
    } else {
        const path = selectedCategoryPath.map(c => c.name).join(' <span class="separator">â†’</span> ');
        breadcrumb.innerHTML = path;
    }
}

async function assignSelectedCategory() {
    if (!selectedCategoryId) {
        alert('Please select a category first');
        return;
    }
    
    // Disable button and show loading
    const btn = document.getElementById('assign-category-btn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Saving...';
    
    try {
        // Check if learning is enabled
        const learn = document.getElementById('learn-checkbox').checked;
        
        // Update the transaction with learning option
        await updateTransactionCategory(currentTransaction, selectedCategoryId, learn);
        
        // Close picker after successful update
        closeCategoryPicker();
    } catch (error) {
        // Re-enable button on error
        btn.disabled = false;
        btn.textContent = originalText;
        throw error;
    }
}

async function selectUncategorized() {
    if (!confirm('Remove category from this transaction?')) {
        return;
    }
    
    await updateTransactionCategory(currentTransaction, null);
    closeCategoryPicker();
}

async function promptNewCategory(parentId, level) {
    const parentName = selectedCategoryPath.length > 0 
        ? selectedCategoryPath[selectedCategoryPath.length - 1].name 
        : 'category';
    
    const name = prompt(`Enter new ${parentName} subcategory name:`);
    
    if (!name || !name.trim()) {
        return;
    }
    
    try {
        // Determine type from parent
        let categoryType = 'expense';  // default
        if (selectedCategoryPath.length > 0) {
            categoryType = selectedCategoryPath[0].type;
        }
        
        const response = await fetch('/categories/api/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name.trim(),
                level: level,
                type: categoryType,
                parent_id: parentId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const newCategoryId = data.category_id;
            
            // Reload categories
            await loadCategoriesForPicker();
            
            // Find the newly created category
            const newCategory = allCategoriesForPicker.find(c => c.id === newCategoryId);
            
            if (newCategory) {
                // Select it immediately
                if (level === 1) {
                    selectLevel1(newCategory);
                } else if (level === 2 && selectedCategoryPath.length >= 1) {
                    showLevel2Categories(allCategoriesForPicker.filter(c => c.parent_id === selectedCategoryPath[0].id));
                    selectLevel2(newCategory);
                } else if (level === 3 && selectedCategoryPath.length >= 2) {
                    showLevel3Categories(allCategoriesForPicker.filter(c => c.parent_id === selectedCategoryPath[1].id));
                    selectLevel3(newCategory);
                }
                
                alert(`âœ… Category "${name}" created and selected!\n\nYou can now click "âœ“ Assign Category" to save.`);
            } else {
                alert(`âœ… Category "${name}" created successfully!`);
                showLevel1Categories();
            }
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error creating category: ' + error.message);
    }
}

// Close overlay on outside click
document.addEventListener('DOMContentLoaded', function() {
    const overlay = document.getElementById('category-picker-modal');
    if (overlay) {
        overlay.addEventListener('click', function(e) {
            if (e.target === this) {
                closeCategoryPicker();
            }
        });
    }
});

// Close on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const overlay = document.getElementById('category-picker-modal');
        if (overlay && overlay.classList.contains('active')) {
            closeCategoryPicker();
        }
    }
});
</script>

