<!-- Category Picker Popover Component -->
<div id="category-picker-modal" class="category-picker-overlay">
    <div class="modal-content category-picker-content" id="category-picker-content">
        <div class="modal-header">
            <h2>Select Category</h2>
            <button class="close-btn" onclick="closeCategoryPicker()">&times;</button>
        </div>
        
        <div class="category-picker-body">
            <!-- Breadcrumb -->
            <div id="category-breadcrumb" class="breadcrumb"></div>
            
            <!-- Main category selection area -->
            <div class="category-columns">
                <div class="category-column" id="level-1-column">
                    <div class="column-title">Category Type</div>
                    <div class="category-list" id="level-1-list"></div>
                </div>
                
                <div class="category-column" id="level-2-column" style="display: none;">
                    <div class="column-title" id="level-2-title">Subcategory</div>
                    <div class="category-list" id="level-2-list"></div>
                </div>
                
                <div class="category-column" id="level-3-column" style="display: none;">
                    <div class="column-title" id="level-3-title">Detail</div>
                    <div class="category-list" id="level-3-list"></div>
                </div>
            </div>
            
            <!-- Learning Option -->
            <div class="learning-option">
                <label>
                    <input type="checkbox" id="learn-checkbox" checked>
                    ðŸ§  Remember this for similar transactions (creates auto-categorization rule)
                </label>
            </div>
            
            <!-- Actions -->
            <div class="picker-actions">
                <button class="btn btn-secondary" onclick="closeCategoryPicker()">Cancel</button>
                <button class="btn btn-warning" onclick="selectUncategorized()">
                    âœ— Clear Category
                </button>
                <button class="btn btn-success" id="assign-category-btn" onclick="assignSelectedCategory()" disabled>
                    âœ“ Assign Category
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.category-picker-content {
    position: absolute;
    max-width: 800px;
    width: 90%;
    max-height: 600px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    z-index: 1001;
    animation: fadeIn 0.15s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.95);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.category-picker-body {
    padding: 20px 0;
}

.breadcrumb {
    padding: 10px 20px;
    background: #f8f9fa;
    border-radius: 4px;
    margin-bottom: 20px;
    font-size: 0.9em;
    color: #666;
    min-height: 20px;
}

.breadcrumb .separator {
    margin: 0 8px;
    color: #999;
}

.category-columns {
    display: flex;
    gap: 10px;
    min-height: 300px;
    padding: 0 20px;
}

.category-column {
    flex: 1;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    overflow: hidden;
}

.column-title {
    background: #667eea;
    color: white;
    padding: 10px;
    font-weight: 600;
    font-size: 0.9em;
    text-align: center;
}

.category-list {
    max-height: 400px;
    overflow-y: auto;
}

.category-option {
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.category-option:hover {
    background: #f8f9fa;
}

.category-option.selected {
    background: #e8f0fe;
    border-left: 4px solid #667eea;
}

.category-option.has-children::after {
    content: 'â€º';
    color: #999;
    font-size: 1.2em;
}

.category-option.new-category {
    color: #667eea;
    font-weight: 600;
    border-top: 2px solid #e0e0e0;
}

.category-option.new-category:hover {
    background: #e8f0fe;
}

.category-badge {
    background: #27ae60;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75em;
    font-weight: 600;
}

.learning-option {
    padding: 15px 20px;
    background: #fff8e1;
    border: 1px solid #ffd54f;
    border-radius: 4px;
    margin: 0 20px;
}

.learning-option label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 0.9em;
    color: #333;
}

.learning-option input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.picker-actions {
    padding: 20px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

@media (max-width: 768px) {
    .category-columns {
        flex-direction: column;
    }
    
    .category-column {
        min-height: 200px;
    }
}
</style>

<script>
let currentTransaction = null;
let selectedCategoryPath = [];
let selectedCategoryId = null;
let allCategoriesForPicker = [];

function openCategoryPicker(transactionId, buttonElement) {
    currentTransaction = transactionId;
    selectedCategoryPath = [];
    selectedCategoryId = null;
    
    console.log('openCategoryPicker called for transaction:', transactionId);
    
    // Load categories and show picker
    loadCategoriesForPicker().then(() => {
        showLevel1Categories();
        
        const overlay = document.getElementById('category-picker-modal');
        const content = document.getElementById('category-picker-content');
        
        overlay.classList.add('active');
        document.getElementById('assign-category-btn').disabled = true;
        
        // Position the picker below the button if provided
        if (buttonElement) {
            const rect = buttonElement.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            
            // Position below the button
            content.style.top = (rect.bottom + scrollTop + 10) + 'px';
            content.style.left = Math.max(20, (rect.left + scrollLeft - 200)) + 'px';
        } else {
            // Center on screen if no button reference
            content.style.top = '50%';
            content.style.left = '50%';
            content.style.transform = 'translate(-50%, -50%)';
        }
    }).catch(error => {
        console.error('Error opening category picker:', error);
        alert('Error loading categories. Please try again.');
    });
}

function closeCategoryPicker() {
    const overlay = document.getElementById('category-picker-modal');
    overlay.classList.remove('active');
    
    currentTransaction = null;
    selectedCategoryPath = [];
    selectedCategoryId = null;
}

async function loadCategoriesForPicker() {
    try {
        const response = await fetch('/categories/api/all');
        const data = await response.json();
        
        if (data.success) {
            allCategoriesForPicker = data.categories;
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

function showLevel1Categories() {
    const level1Categories = allCategoriesForPicker.filter(c => c.level === 1);
    const list = document.getElementById('level-1-list');
    list.innerHTML = '';
    
    // Group by type
    const types = [
        { key: 'income', label: 'ðŸ’° Income', icon: 'ðŸ’°' },
        { key: 'expense', label: 'ðŸ’¸ Expenses', icon: 'ðŸ’¸' },
        { key: 'transfer', label: 'ðŸ’¹ Savings & Investments', icon: 'ðŸ’¹' }
    ];
    
    types.forEach(typeInfo => {
        const typeCats = level1Categories.filter(c => c.type === typeInfo.key);
        
        typeCats.forEach(cat => {
            const div = document.createElement('div');
            div.className = 'category-option has-children';
            div.innerHTML = `
                <span>${typeInfo.icon} ${cat.name}</span>
                <span class="category-badge">${cat.transaction_count || 0}</span>
            `;
            div.onclick = () => selectLevel1(cat);
            list.appendChild(div);
        });
    });
    
    // Add "New Category Type" option
    const newDiv = document.createElement('div');
    newDiv.className = 'category-option new-category';
    newDiv.innerHTML = `<span>âž• Add New Category Type...</span>`;
    newDiv.onclick = () => promptNewCategory(null, 1);
    list.appendChild(newDiv);
    
    // Hide level 2 and 3
    document.getElementById('level-2-column').style.display = 'none';
    document.getElementById('level-3-column').style.display = 'none';
    
    updateBreadcrumb();
}

function selectLevel1(category) {
    selectedCategoryPath = [category];
    
    // Show level 2 children
    const children = allCategoriesForPicker.filter(c => c.parent_id === category.id);
    
    if (children.length > 0) {
        showLevel2Categories(children);
        document.getElementById('level-2-column').style.display = 'block';
        document.getElementById('level-2-title').textContent = category.name;
    } else {
        // No children, can select this
        document.getElementById('level-2-column').style.display = 'none';
        document.getElementById('level-3-column').style.display = 'none';
    }
    
    updateBreadcrumb();
}

function showLevel2Categories(categories) {
    const list = document.getElementById('level-2-list');
    list.innerHTML = '';
    
    categories.forEach(cat => {
        const div = document.createElement('div');
        const hasChildren = allCategoriesForPicker.some(c => c.parent_id === cat.id);
        div.className = `category-option ${hasChildren ? 'has-children' : ''}`;
        div.innerHTML = `
            <span>${cat.name}</span>
            <span class="category-badge">${cat.transaction_count || 0}</span>
        `;
        div.onclick = () => selectLevel2(cat);
        list.appendChild(div);
    });
    
    // Add "New..." option
    const newDiv = document.createElement('div');
    newDiv.className = 'category-option new-category';
    newDiv.innerHTML = `<span>âž• Add New ${selectedCategoryPath[0].name}...</span>`;
    newDiv.onclick = () => promptNewCategory(selectedCategoryPath[0].id, 2);
    list.appendChild(newDiv);
    
    document.getElementById('level-3-column').style.display = 'none';
}

function selectLevel2(category) {
    selectedCategoryPath = [selectedCategoryPath[0], category];
    selectedCategoryId = category.id;
    
    // Highlight selection in level 2
    document.querySelectorAll('#level-2-list .category-option').forEach(el => {
        el.classList.remove('selected');
    });
    event.target.closest('.category-option').classList.add('selected');
    
    // Show level 3 children if they exist
    const children = allCategoriesForPicker.filter(c => c.parent_id === category.id);
    
    if (children.length > 0) {
        showLevel3Categories(children);
        document.getElementById('level-3-column').style.display = 'block';
        document.getElementById('level-3-title').textContent = category.name;
    } else {
        // No children, this is selectable
        document.getElementById('level-3-column').style.display = 'none';
    }
    
    // Enable assign button
    document.getElementById('assign-category-btn').disabled = false;
    updateBreadcrumb();
}

function showLevel3Categories(categories) {
    const list = document.getElementById('level-3-list');
    list.innerHTML = '';
    
    categories.forEach(cat => {
        const div = document.createElement('div');
        div.className = 'category-option';
        div.innerHTML = `
            <span>${cat.name}</span>
            <span class="category-badge">${cat.transaction_count || 0}</span>
        `;
        div.onclick = () => selectLevel3(cat);
        list.appendChild(div);
    });
    
    // Add "New..." option
    const newDiv = document.createElement('div');
    newDiv.className = 'category-option new-category';
    newDiv.innerHTML = `<span>âž• Add New ${selectedCategoryPath[1].name}...</span>`;
    newDiv.onclick = () => promptNewCategory(selectedCategoryPath[1].id, 3);
    list.appendChild(newDiv);
}

function selectLevel3(category) {
    selectedCategoryPath = [selectedCategoryPath[0], selectedCategoryPath[1], category];
    selectedCategoryId = category.id;
    
    // Highlight selection in level 3
    document.querySelectorAll('#level-3-list .category-option').forEach(el => {
        el.classList.remove('selected');
    });
    event.target.closest('.category-option').classList.add('selected');
    
    // Enable assign button
    document.getElementById('assign-category-btn').disabled = false;
    updateBreadcrumb();
}

function updateBreadcrumb() {
    const breadcrumb = document.getElementById('category-breadcrumb');
    
    if (selectedCategoryPath.length === 0) {
        breadcrumb.innerHTML = 'Select a category type...';
    } else {
        const path = selectedCategoryPath.map(c => c.name).join(' <span class="separator">â†’</span> ');
        breadcrumb.innerHTML = path;
    }
}

async function assignSelectedCategory() {
    if (!selectedCategoryId) {
        alert('Please select a category first');
        return;
    }
    
    // Disable button and show loading
    const btn = document.getElementById('assign-category-btn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Saving...';
    
    try {
        // Check if learning is enabled
        const learn = document.getElementById('learn-checkbox').checked;
        
        // Update the transaction with learning option
        await updateTransactionCategory(currentTransaction, selectedCategoryId, learn);
        
        // Close picker after successful update
        closeCategoryPicker();
    } catch (error) {
        // Re-enable button on error
        btn.disabled = false;
        btn.textContent = originalText;
        throw error;
    }
}

async function selectUncategorized() {
    if (!confirm('Remove category from this transaction?')) {
        return;
    }
    
    await updateTransactionCategory(currentTransaction, null);
    closeCategoryPicker();
}

async function promptNewCategory(parentId, level) {
    const parentName = selectedCategoryPath.length > 0 
        ? selectedCategoryPath[selectedCategoryPath.length - 1].name 
        : 'category';
    
    const name = prompt(`Enter new ${parentName} subcategory name:`);
    
    if (!name || !name.trim()) {
        return;
    }
    
    try {
        // Determine type from parent
        let categoryType = 'expense';  // default
        if (selectedCategoryPath.length > 0) {
            categoryType = selectedCategoryPath[0].type;
        }
        
        const response = await fetch('/categories/api/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name.trim(),
                level: level,
                type: categoryType,
                parent_id: parentId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`âœ… Category "${name}" created successfully!`);
            // Reload categories and refresh picker
            await loadCategoriesForPicker();
            showLevel1Categories();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error creating category: ' + error.message);
    }
}

// Close overlay on outside click
document.addEventListener('DOMContentLoaded', function() {
    const overlay = document.getElementById('category-picker-modal');
    if (overlay) {
        overlay.addEventListener('click', function(e) {
            if (e.target === this) {
                closeCategoryPicker();
            }
        });
    }
});

// Close on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const overlay = document.getElementById('category-picker-modal');
        if (overlay && overlay.classList.contains('active')) {
            closeCategoryPicker();
        }
    }
});
</script>

