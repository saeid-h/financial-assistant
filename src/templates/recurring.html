{% extends "base.html" %}

{% block title %}Recurring Transactions - {{ app_name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>üîÑ Recurring Transactions</h1>
        <div class="header-actions">
            <button id="scan-btn" class="btn btn-success">üîç Scan for New Patterns</button>
        </div>
    </div>

    <!-- Statistics Dashboard -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Active Recurring</div>
            <div class="stat-value" id="active-count">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Monthly Total</div>
            <div class="stat-value" id="monthly-total">$0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Upcoming (7 days)</div>
            <div class="stat-value" id="upcoming-count">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Alerts</div>
            <div class="stat-value" id="alert-count">0</div>
        </div>
    </div>

    <!-- Alerts Section -->
    <div id="alerts-section" style="display: none; margin-top: 20px;">
        <div class="card">
            <div class="card-header">
                <h2>üö® Alerts</h2>
            </div>
            <div class="card-body">
                <div id="alerts-list"></div>
            </div>
        </div>
    </div>

    <!-- Recurring Transactions List -->
    <div class="card" style="margin-top: 20px;">
        <div class="card-header">
            <h2>üìã Active Recurring Transactions</h2>
            <div>
                <select id="status-filter" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">All Status</option>
                    <option value="active" selected>Active</option>
                    <option value="paused">Paused</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <div id="recurring-list"></div>
            <div id="empty-state" style="text-align: center; padding: 40px; color: #999; display: none;">
                <p style="font-size: 1.2rem;">üì≠ No recurring transactions found</p>
                <p>Click "üîç Scan for New Patterns" to detect subscriptions and bills</p>
            </div>
        </div>
    </div>
</div>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-label {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 10px;
}

.stat-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #333;
}

.recurring-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.recurring-card.paused {
    opacity: 0.6;
    background: #f8f9fa;
}

.recurring-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.recurring-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: #333;
}

.recurring-frequency {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
    background: #667eea;
    color: white;
}

.recurring-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.recurring-detail {
    display: flex;
    flex-direction: column;
}

.recurring-detail-label {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 4px;
}

.recurring-detail-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
}

.recurring-actions {
    display: flex;
    gap: 10px;
}

.alert-item {
    padding: 15px;
    border-left: 4px solid;
    margin-bottom: 10px;
    border-radius: 4px;
}

.alert-item.missing {
    background: #fff3cd;
    border-color: #ffc107;
}

.alert-item.changed {
    background: #f8d7da;
    border-color: #dc3545;
}

.alert-title {
    font-weight: 700;
    margin-bottom: 5px;
}

.alert-details {
    font-size: 0.9rem;
    color: #666;
}
</style>

<script>
async function loadStats() {
    try {
        const response = await fetch('/recurring/api/stats');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('active-count').textContent = data.stats.active_count;
            document.getElementById('monthly-total').textContent = formatCurrency(data.stats.monthly_total);
            document.getElementById('upcoming-count').textContent = data.stats.upcoming_count;
            document.getElementById('alert-count').textContent = data.stats.alert_count;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadRecurring() {
    try {
        const status = document.getElementById('status-filter').value;
        const url = `/recurring/api/all${status ? '?status=' + status : ''}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            displayRecurring(data.recurring_transactions);
        }
    } catch (error) {
        console.error('Error loading recurring:', error);
    }
}

async function loadAlerts() {
    try {
        const response = await fetch('/recurring/api/alerts');
        const data = await response.json();
        
        if (data.success) {
            displayAlerts(data.alerts);
        }
    } catch (error) {
        console.error('Error loading alerts:', error);
    }
}

function displayRecurring(recurring) {
    const container = document.getElementById('recurring-list');
    const emptyState = document.getElementById('empty-state');
    
    if (!recurring || recurring.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    container.innerHTML = recurring.map(rec => `
        <div class="recurring-card ${rec.status}">
            <div class="recurring-header">
                <div class="recurring-title">${escapeHtml(rec.merchant_name)}</div>
                <span class="recurring-frequency">${formatFrequency(rec.frequency)}</span>
            </div>
            
            <div class="recurring-details">
                <div class="recurring-detail">
                    <span class="recurring-detail-label">Average Amount</span>
                    <span class="recurring-detail-value">${formatCurrency(rec.average_amount)}</span>
                </div>
                <div class="recurring-detail">
                    <span class="recurring-detail-label">Category</span>
                    <span class="recurring-detail-value">${rec.category_name || 'Uncategorized'}</span>
                </div>
                <div class="recurring-detail">
                    <span class="recurring-detail-label">Next Expected</span>
                    <span class="recurring-detail-value">${rec.next_expected_date || 'N/A'}</span>
                </div>
                <div class="recurring-detail">
                    <span class="recurring-detail-label">Confidence</span>
                    <span class="recurring-detail-value">${Math.round(rec.confidence_score * 100)}%</span>
                </div>
            </div>
            
            <div class="recurring-actions">
                ${rec.status === 'active' ? 
                    `<button class="btn btn-sm" style="background: #6c757d; color: white;" onclick="pauseRecurring(${rec.id})">‚è∏Ô∏è Pause</button>` :
                    `<button class="btn btn-sm btn-success" onclick="resumeRecurring(${rec.id})">‚ñ∂Ô∏è Resume</button>`
                }
                <button class="btn btn-sm btn-danger" onclick="deleteRecurring(${rec.id}, '${escapeHtml(rec.merchant_name)}')">Delete</button>
            </div>
        </div>
    `).join('');
}

function displayAlerts(alerts) {
    const section = document.getElementById('alerts-section');
    const container = document.getElementById('alerts-list');
    
    const totalAlerts = (alerts.missing || []).length + (alerts.changed || []).length;
    
    if (totalAlerts === 0) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    
    let html = '';
    
    // Missing payments
    if (alerts.missing && alerts.missing.length > 0) {
        html += alerts.missing.map(alert => `
            <div class="alert-item missing">
                <div class="alert-title">‚ö†Ô∏è Missing Payment: ${escapeHtml(alert.merchant_name)}</div>
                <div class="alert-details">
                    Expected: ${alert.next_expected_date} (${alert.days_late} days late)
                    <br>Amount: ${formatCurrency(alert.average_amount)}
                </div>
            </div>
        `).join('');
    }
    
    // Amount changes
    if (alerts.changed && alerts.changed.length > 0) {
        html += alerts.changed.map(alert => `
            <div class="alert-item changed">
                <div class="alert-title">üìä Amount Changed: ${escapeHtml(alert.merchant_name)}</div>
                <div class="alert-details">
                    Old: ${formatCurrency(alert.old_amount)} ‚Üí New: ${formatCurrency(alert.new_amount)}
                    <br>Change: ${alert.variance_percent}% (${formatCurrency(alert.difference)})
                </div>
            </div>
        `).join('');
    }
    
    container.innerHTML = html;
}

async function scanForPatterns() {
    const btn = document.getElementById('scan-btn');
    const originalText = btn.textContent;
    
    if (!confirm('Scan all transactions for recurring patterns?\n\nThis will analyze your transaction history and detect subscriptions, bills, and regular payments.')) {
        return;
    }
    
    btn.disabled = true;
    btn.textContent = 'üîç Scanning...';
    
    try {
        const response = await fetch('/recurring/api/scan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`‚úÖ Scan Complete!\n\n` +
                  `Patterns found: ${data.total_patterns}\n` +
                  `Successfully saved: ${data.saved}\n` +
                  `Skipped: ${data.skipped}`);
            
            loadStats();
            loadRecurring();
            loadAlerts();
        } else {
            alert('Error: ' + (data.error || 'Scan failed'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

async function pauseRecurring(id) {
    try {
        const response = await fetch(`/recurring/api/${id}/pause`, {method: 'POST'});
        const data = await response.json();
        
        if (data.success) {
            loadRecurring();
            loadStats();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function resumeRecurring(id) {
    try {
        const response = await fetch(`/recurring/api/${id}/resume`, {method: 'POST'});
        const data = await response.json();
        
        if (data.success) {
            loadRecurring();
            loadStats();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteRecurring(id, name) {
    if (!confirm(`Delete recurring transaction "${name}"?\n\nThis will remove the recurring pattern and all its history.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/recurring/api/${id}`, {method: 'DELETE'});
        const data = await response.json();
        
        if (data.success) {
            loadRecurring();
            loadStats();
            loadAlerts();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function formatFrequency(freq) {
    const icons = {
        'weekly': 'üìÖ Weekly',
        'biweekly': 'üìÖ Bi-Weekly',
        'monthly': 'üìÜ Monthly',
        'quarterly': 'üìä Quarterly',
        'annual': 'üìà Annual'
    };
    return icons[freq] || freq;
}

function formatCurrency(amount) {
    if (amount === null || amount === undefined) return '$0.00';
    return '$' + Math.abs(amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadRecurring();
    loadAlerts();
    
    document.getElementById('scan-btn').addEventListener('click', scanForPatterns);
    document.getElementById('status-filter').addEventListener('change', loadRecurring);
});
</script>
{% endblock %}

