{% extends "base.html" %}

{% block title %}Financial Reports{% endblock %}

{% block content %}
<div class="reports-page">
    <h1>Financial Reports</h1>
    
    <!-- Report Navigation -->
    <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h2 style="font-size: 1.2rem; margin-bottom: 15px;">ğŸ“‹ Available Reports</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <a href="/reports" style="text-decoration: none; color: inherit; padding: 15px; border: 2px solid #667eea; border-radius: 8px; background: #f8f9ff; transition: all 0.2s;">
                <div style="font-weight: 700; margin-bottom: 5px;">ğŸ“Š Standard Charts</div>
                <div style="font-size: 0.85rem; color: #666;">Income, expenses, categories, trends</div>
            </a>
            <a href="/reports/month-comparison" style="text-decoration: none; color: inherit; padding: 15px; border: 2px solid #28a745; border-radius: 8px; background: #f1f9f3; transition: all 0.2s;">
                <div style="font-weight: 700; margin-bottom: 5px;">ğŸ“… Month Comparison</div>
                <div style="font-size: 0.85rem; color: #666;">Side-by-side month analysis</div>
            </a>
            <a href="/reports/merchants" style="text-decoration: none; color: inherit; padding: 15px; border: 2px solid #ffc107; border-radius: 8px; background: #fffbf0; transition: all 0.2s;">
                <div style="font-weight: 700; margin-bottom: 5px;">ğŸª Merchant Analysis</div>
                <div style="font-size: 0.85rem; color: #666;">Top merchants and spending patterns</div>
            </a>
            <a href="/reports/net-worth" style="text-decoration: none; color: inherit; padding: 15px; border: 2px solid #17a2b8; border-radius: 8px; background: #f0f9fb; transition: all 0.2s;">
                <div style="font-weight: 700; margin-bottom: 5px;">ğŸ’ Net Worth Tracker</div>
                <div style="font-size: 0.85rem; color: #666;">Wealth trajectory over time</div>
            </a>
            <a href="/reports/builder" style="text-decoration: none; color: inherit; padding: 15px; border: 2px solid #6f42c1; border-radius: 8px; background: #f8f4fc; transition: all 0.2s;">
                <div style="font-weight: 700; margin-bottom: 5px;">ğŸ”§ Custom Report Builder</div>
                <div style="font-size: 0.85rem; color: #666;">Build your own custom reports</div>
            </a>
        </div>
    </div>
    
    <!-- Filters Section -->
    <div class="report-filters">
        <div class="filter-group">
            <label for="date-range">Date Range:</label>
            <select id="date-range" class="form-control">
                <option value="this-month">This Month</option>
                <option value="last-month">Last Month</option>
                <option value="last-3-months">Last 3 Months</option>
                <option value="last-6-months">Last 6 Months</option>
                <option value="last-12-months" selected>Last 12 Months</option>
                <option value="this-year">This Year</option>
                <option value="last-year">Last Year</option>
                <option value="custom">Custom Range...</option>
            </select>
        </div>
        
        <div class="filter-group" id="custom-dates" style="display: none;">
            <input type="date" id="start-date" class="form-control">
            <span class="date-separator">to</span>
            <input type="date" id="end-date" class="form-control">
        </div>
        
        <div class="filter-group">
            <label for="account-filter">Account:</label>
            <select id="account-filter" class="form-control">
                <option value="all">All Accounts</option>
                <!-- Populated dynamically -->
            </select>
        </div>
        
        <div class="filter-actions">
            <button id="apply-filters" class="btn btn-primary">Apply Filters</button>
            <button id="reset-filters" class="btn btn-secondary">Reset</button>
            <button id="export-csv" class="btn btn-success">Export CSV</button>
        </div>
    </div>
    
    <!-- Charts Grid -->
    <div class="charts-grid">
        <!-- Income vs Expenses Line Chart -->
        <div class="chart-card">
            <h3>Income vs Expenses</h3>
            <div class="chart-loading" id="income-expense-loading">
                <div class="spinner"></div>
                <span>Loading chart...</span>
            </div>
            <div class="chart-container" id="income-expense-container" style="display: none;">
                <canvas id="income-expense-chart"></canvas>
            </div>
            <div class="chart-error" id="income-expense-error" style="display: none;">
                <p>Unable to load chart. Please try again.</p>
            </div>
            <div class="chart-empty" id="income-expense-empty" style="display: none;">
                <p>No data available for the selected period.</p>
            </div>
        </div>
        
        <!-- Category Pie Chart -->
        <div class="chart-card">
            <h3>This Period's Spending</h3>
            <div class="chart-loading" id="category-pie-loading">
                <div class="spinner"></div>
                <span>Loading chart...</span>
            </div>
            <div class="chart-container" id="category-pie-container" style="display: none;">
                <canvas id="category-pie-chart"></canvas>
            </div>
            <div class="chart-error" id="category-pie-error" style="display: none;">
                <p>Unable to load chart. Please try again.</p>
            </div>
            <div class="chart-empty" id="category-pie-empty" style="display: none;">
                <p>No spending data available.</p>
            </div>
        </div>
        
        <!-- Monthly Category Trends Stacked Bar Chart -->
        <div class="chart-card full-width">
            <h3>Monthly Expenses by Category</h3>
            <div class="chart-loading" id="monthly-category-loading">
                <div class="spinner"></div>
                <span>Loading chart...</span>
            </div>
            <div class="chart-container" id="monthly-category-container" style="display: none;">
                <canvas id="monthly-category-chart"></canvas>
            </div>
            <div class="chart-error" id="monthly-category-error" style="display: none;">
                <p>Unable to load chart. Please try again.</p>
            </div>
            <div class="chart-empty" id="monthly-category-empty" style="display: none;">
                <p>No monthly data available.</p>
            </div>
        </div>
        
        <!-- Top Categories Horizontal Bar Chart -->
        <div class="chart-card full-width">
            <h3>Top Spending Categories</h3>
            <div class="chart-loading" id="top-categories-loading">
                <div class="spinner"></div>
                <span>Loading chart...</span>
            </div>
            <div class="chart-container" id="top-categories-container" style="display: none;">
                <canvas id="top-categories-chart"></canvas>
            </div>
            <div class="chart-error" id="top-categories-error" style="display: none;">
                <p>Unable to load chart. Please try again.</p>
            </div>
            <div class="chart-empty" id="top-categories-empty" style="display: none;">
                <p>No category data available.</p>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
console.log('Reports page loaded - Chart.js version:', Chart.version);

// Chart instances (global so they can be destroyed and recreated)
let incomeExpenseChart = null;
let categoryPieChart = null;
let monthlyCategoryChart = null;
let topCategoriesChart = null;

// Helper function to format currency
function formatCurrency(amount) {
    return '$' + Math.abs(amount).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Helper function to get filter parameters
function getFilterParams() {
    const params = new URLSearchParams();
    
    // Account filter
    const accountId = document.getElementById('account-filter').value;
    if (accountId && accountId !== 'all') {
        params.append('account_id', accountId);
    }
    
    // Date range filter
    const dateRange = document.getElementById('date-range').value;
    const [startDate, endDate] = calculateDateRange(dateRange);
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    return params;
}

// Calculate date range based on preset
function calculateDateRange(preset) {
    const today = new Date();
    let startDate, endDate = today;
    
    switch(preset) {
        case 'this-month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            break;
        case 'last-month':
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
        case 'last-3-months':
            startDate = new Date(today.getFullYear(), today.getMonth() - 3, 1);
            break;
        case 'last-6-months':
            startDate = new Date(today.getFullYear(), today.getMonth() - 6, 1);
            break;
        case 'last-12-months':
            startDate = new Date(today.getFullYear(), today.getMonth() - 12, 1);
            break;
        case 'this-year':
            startDate = new Date(today.getFullYear(), 0, 1);
            break;
        case 'last-year':
            startDate = new Date(today.getFullYear() - 1, 0, 1);
            endDate = new Date(today.getFullYear() - 1, 11, 31);
            break;
        case 'custom':
            const startInput = document.getElementById('start-date').value;
            const endInput = document.getElementById('end-date').value;
            return [startInput, endInput];
        default:
            startDate = new Date(today.getFullYear(), today.getMonth() - 12, 1);
    }
    
    return [
        startDate.toISOString().split('T')[0],
        endDate.toISOString().split('T')[0]
    ];
}

// Show/hide chart states
function showLoading(chartId) {
    document.getElementById(`${chartId}-loading`).style.display = 'flex';
    document.getElementById(`${chartId}-container`).style.display = 'none';
    document.getElementById(`${chartId}-error`).style.display = 'none';
    document.getElementById(`${chartId}-empty`).style.display = 'none';
}

function showChart(chartId) {
    document.getElementById(`${chartId}-loading`).style.display = 'none';
    document.getElementById(`${chartId}-container`).style.display = 'block';
    document.getElementById(`${chartId}-error`).style.display = 'none';
    document.getElementById(`${chartId}-empty`).style.display = 'none';
}

function showEmpty(chartId) {
    document.getElementById(`${chartId}-loading`).style.display = 'none';
    document.getElementById(`${chartId}-container`).style.display = 'none';
    document.getElementById(`${chartId}-error`).style.display = 'none';
    document.getElementById(`${chartId}-empty`).style.display = 'block';
}

function showError(chartId) {
    document.getElementById(`${chartId}-loading`).style.display = 'none';
    document.getElementById(`${chartId}-container`).style.display = 'none';
    document.getElementById(`${chartId}-error`).style.display = 'block';
    document.getElementById(`${chartId}-empty`).style.display = 'none';
}

// Load accounts for filter dropdown
async function loadAccounts() {
    try {
        const response = await fetch('/accounts/api/');
        const accounts = await response.json();
        
        const select = document.getElementById('account-filter');
        // Clear existing options except "All Accounts"
        while (select.options.length > 1) {
            select.remove(1);
        }
        
        accounts.forEach(account => {
            const option = document.createElement('option');
            option.value = account.id;
            option.textContent = `${account.name} (${account.type})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading accounts:', error);
    }
}

// Load Income vs Expenses Line Chart
async function loadIncomeExpenseChart() {
    const chartId = 'income-expense';
    showLoading(chartId);
    
    try {
        const params = getFilterParams();
        const response = await fetch(`/reports/api/income-expenses?${params}`);
        const data = await response.json();
        
        if (!data.labels || data.labels.length === 0) {
            showEmpty(chartId);
            return;
        }
        
        if (incomeExpenseChart) {
            incomeExpenseChart.destroy();
        }
        
        const ctx = document.getElementById('income-expense-chart').getContext('2d');
        incomeExpenseChart = new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
        
        showChart(chartId);
    } catch (error) {
        console.error('Error loading income/expense chart:', error);
        showError(chartId);
    }
}

// Load Category Pie Chart
async function loadCategoryPieChart() {
    const chartId = 'category-pie';
    showLoading(chartId);
    
    try {
        const params = getFilterParams();
        const response = await fetch(`/reports/api/category-breakdown?${params}`);
        const data = await response.json();
        
        if (!data.labels || data.labels.length === 0) {
            showEmpty(chartId);
            return;
        }
        
        if (categoryPieChart) {
            categoryPieChart.destroy();
        }
        
        const ctx = document.getElementById('category-pie-chart').getContext('2d');
        categoryPieChart = new Chart(ctx, {
            type: 'pie',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'right'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = formatCurrency(context.parsed);
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        showChart(chartId);
    } catch (error) {
        console.error('Error loading category pie chart:', error);
        showError(chartId);
    }
}

// Load Monthly Category Stacked Bar Chart
async function loadMonthlyCategoryChart() {
    const chartId = 'monthly-category';
    showLoading(chartId);
    
    try {
        const params = getFilterParams();
        const response = await fetch(`/reports/api/monthly-category-trends?${params}`);
        const data = await response.json();
        
        if (!data.labels || data.labels.length === 0) {
            showEmpty(chartId);
            return;
        }
        
        if (monthlyCategoryChart) {
            monthlyCategoryChart.destroy();
        }
        
        const ctx = document.getElementById('monthly-category-chart').getContext('2d');
        monthlyCategoryChart = new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
        
        showChart(chartId);
    } catch (error) {
        console.error('Error loading monthly category chart:', error);
        showError(chartId);
    }
}

// Load Top Categories Horizontal Bar Chart
async function loadTopCategoriesChart() {
    const chartId = 'top-categories';
    showLoading(chartId);
    
    try {
        const params = getFilterParams();
        const response = await fetch(`/reports/api/top-categories?${params}`);
        const data = await response.json();
        
        if (!data.labels || data.labels.length === 0) {
            showEmpty(chartId);
            return;
        }
        
        if (topCategoriesChart) {
            topCategoriesChart.destroy();
        }
        
        const ctx = document.getElementById('top-categories-chart').getContext('2d');
        topCategoriesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: data.datasets
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const index = context.dataIndex;
                                const amount = formatCurrency(context.parsed.x);
                                const count = data.metadata.transaction_counts[index];
                                const avg = formatCurrency(data.metadata.averages[index]);
                                return [
                                    `Total: ${amount}`,
                                    `Transactions: ${count}`,
                                    `Average: ${avg}`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
        
        showChart(chartId);
    } catch (error) {
        console.error('Error loading top categories chart:', error);
        showError(chartId);
    }
}

// Refresh all charts
function refreshAllCharts() {
    loadIncomeExpenseChart();
    loadCategoryPieChart();
    loadMonthlyCategoryChart();
    loadTopCategoriesChart();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    console.log('Initializing reports page...');
    
    // Load accounts for filter
    loadAccounts();
    
    // Load all charts
    refreshAllCharts();
    
    // Wire up filter controls
    document.getElementById('apply-filters').addEventListener('click', refreshAllCharts);
    
    document.getElementById('reset-filters').addEventListener('click', () => {
        document.getElementById('date-range').value = 'last-12-months';
        document.getElementById('account-filter').value = 'all';
        document.getElementById('custom-dates').style.display = 'none';
        refreshAllCharts();
    });
    
    // Show/hide custom date inputs
    document.getElementById('date-range').addEventListener('change', (e) => {
        const customDates = document.getElementById('custom-dates');
        customDates.style.display = e.target.value === 'custom' ? 'flex' : 'none';
    });
    
    // Export functionality
    document.getElementById('export-csv').addEventListener('click', () => {
        const params = getFilterParams();
        window.location.href = `/reports/api/export?${params}`;
    });
});
</script>
{% endblock %}

