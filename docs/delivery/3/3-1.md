# Task 3-1: Fix Import Session Cookie Bug

[Back to task list](./tasks.md)

## Description

Fix the session cookie size limit issue that prevents importing large CSV files (800+ transactions). The Flask session cookie has a 4KB limit, but storing all transactions exceeds this, causing the browser to silently ignore the cookie and resulting in "No pending import found" errors.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-19 21:20:00 | Created | N/A | Proposed | Task created to fix critical import bug | Saeed |
| 2025-10-19 21:20:00 | Approved | Proposed | Agreed | Critical bug blocking large imports | Saeed |
| 2025-10-19 21:20:00 | Started | Agreed | InProgress | Implementing session-less confirmation | Saeed |
| 2025-10-19 21:25:00 | Completed | InProgress | Review | Session fix implemented and tested | Saeed |
| 2025-10-19 21:26:00 | Approved | Review | Done | Import now works with 815+ transactions | Saeed |

## Requirements

1. Support importing CSV files with 800+ transactions
2. Keep session cookie size under 4KB limit
3. Maintain preview functionality
4. Don't break existing import workflow
5. No data loss during confirmation
6. Handle file cleanup properly

## Implementation Plan

### Problem Analysis
- Flask session stored in signed cookie (max ~4KB)
- 815 transactions × ~30 bytes each = ~24KB
- Browser ignores cookie > 4KB
- Session appears empty on confirmation

### Solution
**Don't store transactions in session. Re-parse from temp file on confirmation.**

**Session Storage (Before)**:
```python
session['pending_transactions'] = [all 815 transactions]  # 24KB!
session['import_account_id'] = account_id
session['import_filename'] = filename
```

**Session Storage (After)**:
```python
session['import_account_id'] = account_id  # 4 bytes
session['import_filename'] = filename  # ~50 bytes
session['import_temp_file'] = temp_path  # ~100 bytes
session['import_valid_count'] = count  # 4 bytes
# Total: ~160 bytes ✓
```

**Confirmation Flow (After)**:
1. Get temp_file_path from session
2. Re-parse CSV file
3. Re-validate transactions
4. Save to database
5. Archive CSV
6. Clean up temp file

### Changes Required

**File**: `src/routes/import_routes.py`

**upload endpoint**:
- Remove transaction storage from session
- Keep only metadata (account_id, filename, temp_path, count)
- Don't delete temp file after upload

**confirm endpoint**:
- Check temp file exists
- Re-parse using CSVParser
- Re-validate using TransactionValidator
- Save valid transactions
- Archive CSV file
- Delete temp file
- Clear session

## Test Plan

**Success Criteria**:
- Import 815 transactions successfully
- No session cookie warnings
- Preview shows correctly
- Confirmation works
- All transactions saved
- CSV archived properly

**Test Cases**:
- Small file (3 transactions) - baseline
- Medium file (50 transactions)
- Large file (815 transactions) - Chase actual data
- Very large file (2000+ transactions)
- Multiple sequential imports
- Cancel import (temp file cleaned up)

## Verification

- [x] Session storage redesigned
- [x] Temp file kept through workflow
- [x] Re-parsing on confirmation implemented
- [x] File archiving integrated
- [x] Cleanup handled correctly
- [x] No cookie size warnings
- [x] 815 transactions import successfully
- [x] Integration tests still pass

## Files Modified

**Modified**:
- `src/routes/import_routes.py`
  - upload endpoint: Store metadata only
  - confirm endpoint: Re-parse and save
  - Removed pending_transactions from session

## Notes

**Root Cause**: Flask's default session uses signed cookies (client-side storage) which have a ~4KB limit after base64 encoding.

**Alternative Considered**: Server-side sessions (Flask-Session extension)
- Rejected: Adds dependency, overkill for this use case
- Current solution is simpler and more reliable

**Performance**: Re-parsing 815 transactions takes ~0.1 seconds (negligible)

**Benefits**:
- No size limit on imports
- Simpler session management
- More reliable
- Less memory usage


