# Task 2-2: Create CSV Parser Service

[Back to task list](./tasks.md)

## Description

Implement a flexible CSV parser service that can handle various bank statement formats. The parser should use pandas to read CSV files, auto-detect delimiters and date formats, and extract transaction data into a standardized structure.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-19 19:15:00 | Created | N/A | Proposed | Task created | Saeed |
| 2025-10-19 19:15:00 | Approved | Proposed | Agreed | Task approved for implementation | Saeed |
| 2025-10-19 19:15:00 | Started | Agreed | InProgress | Beginning implementation | Saeed |
| 2025-10-19 19:30:00 | Completed | InProgress | Review | Implementation and tests complete, all 20 tests passing | Saeed |

## Requirements

1. Parse CSV files with various formats
2. Auto-detect delimiter (comma, semicolon, tab)
3. Auto-detect date formats (MM/DD/YYYY, DD/MM/YYYY, YYYY-MM-DD, etc.)
4. Extract required fields: date, description, amount
5. Handle both debit/credit columns and single amount column
6. Handle balance column (optional)
7. Return standardized transaction list
8. Provide clear error messages for invalid files
9. Support common bank CSV formats

## Implementation Plan

### 1. Create CSV Parser Service (`src/services/csv_parser.py`)

**Key Features:**
- Use pandas for robust CSV parsing
- Flexible column detection
- Date parsing with multiple formats
- Amount normalization (handle negative for expenses, separate debit/credit)
- Error handling with detailed messages

**Column Detection Strategy:**
- Common date column names: date, transaction date, posting date, trans date
- Common description names: description, merchant, payee, details, memo
- Common amount names: amount, debit, credit, withdrawal, deposit
- Case-insensitive matching

**Return Format:**
```python
[
    {
        'date': datetime.date(2025, 10, 19),
        'description': 'Grocery Store',
        'amount': -45.50,  # negative for expenses
        'raw_data': {...}  # original row for debugging
    },
    ...
]
```

### 2. Support Multiple CSV Formats

**Format 1: Single Amount Column**
```csv
Date,Description,Amount,Balance
10/19/2025,Grocery Store,-45.50,1234.50
```

**Format 2: Separate Debit/Credit**
```csv
Date,Merchant,Debit,Credit,Balance
10/19/2025,Salary Deposit,,2500.00,3734.50
10/20/2025,Rent Payment,1200.00,,2534.50
```

**Format 3: Withdrawal/Deposit**
```csv
Transaction Date,Details,Withdrawal,Deposit
2025-10-19,Grocery Store,45.50,
2025-10-20,Paycheck,,2500.00
```

### 3. Error Handling

- File not found
- Invalid CSV format
- Missing required columns
- Invalid date format
- Invalid amount format
- Empty file
- Non-numeric amounts

## Test Plan

**Success Criteria:**
- Parse standard CSV format correctly
- Auto-detect delimiter
- Parse various date formats
- Handle debit/credit columns
- Handle single amount column
- Normalize amounts correctly
- Return standardized format
- Clear error messages

**Unit Tests:**
- test_parse_standard_csv()
- test_parse_semicolon_delimiter()
- test_parse_tab_delimiter()
- test_parse_various_date_formats()
- test_parse_debit_credit_columns()
- test_parse_single_amount_column()
- test_parse_negative_amounts()
- test_missing_required_columns()
- test_invalid_date_format()
- test_invalid_amount_format()
- test_empty_file()

## Verification

- [x] CSV parser service created
- [x] Supports multiple delimiters (comma, semicolon, tab)
- [x] Handles various date formats (MM/DD/YYYY, DD/MM/YYYY, YYYY-MM-DD)
- [x] Handles debit/credit columns
- [x] Handles single amount column
- [x] Returns standardized format
- [x] Error handling comprehensive
- [x] Tests passing (20/20 tests)

## Files Modified

**Created:**
- `src/services/csv_parser.py`
- `src/services/__init__.py` (update)
- `tests/unit/test_csv_parser.py`
- `tests/fixtures/sample_statements/` (test CSV files)

## Notes

- pandas is already installed
- python-dateutil is already installed for flexible date parsing
- Keep parser flexible for future format additions
- Store raw_data in each transaction for debugging

