# [5-8] Implement CSV export functionality

[Back to task list](./tasks.md)

## Description

Allow users to export all report data to a CSV file for further analysis in spreadsheet applications. The export should respect current filter settings and include all relevant metrics.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-19 23:25:00 | Created | N/A | Proposed | Task file created | Saeed |
| 2025-10-19 23:55:00 | Status Change | Proposed | Agreed | Task approved | Saeed |
| 2025-10-19 23:55:00 | Status Change | Agreed | InProgress | Started implementation | Saeed |
| 2025-10-20 00:00:00 | Status Change | InProgress | Done | CSV export complete with filtered data, timestamped filenames, and multi-section format | Saeed |

## Requirements

### Functional Requirements
1. Create API endpoint `/reports/api/export` that generates CSV
2. Export includes multiple sections:
   - Monthly Income vs Expenses summary
   - Category breakdown
   - Top categories list
   - Monthly category trends (pivot table format)
3. Export respects current filter settings (date range, account)
4. CSV filename includes date range and timestamp
5. Trigger download on button click

### Implementation Plan

1. **API Endpoint**: Add route to `src/routes/reports.py`:
   ```python
   @reports_bp.route('/api/export')
   def export_report_data():
       """Export report data as CSV"""
       import csv
       from io import StringIO
       from flask import make_response
       
       # Get filters
       account_id = request.args.get('account_id', type=int)
       start_date = request.args.get('start_date')
       end_date = request.args.get('end_date')
       
       # Parse dates
       if start_date:
           start_date = datetime.strptime(start_date, '%Y-%m-%d').date()
       if end_date:
           end_date = datetime.strptime(end_date, '%Y-%m-%d').date()
       
       # Get all data
       report_service = ReportService(current_app.config['DATABASE'])
       
       income_expenses = report_service.get_monthly_income_expenses(
           account_id, start_date, end_date)
       category_breakdown = report_service.get_category_breakdown(
           account_id, start_date, end_date)
       top_categories = report_service.get_top_categories(
           account_id, start_date, end_date)
       
       # Build CSV
       output = StringIO()
       writer = csv.writer(output)
       
       # Section 1: Monthly Summary
       writer.writerow(['Monthly Income vs Expenses Summary'])
       writer.writerow(['Month', 'Income', 'Expenses', 'Net'])
       for row in income_expenses:
           writer.writerow([
               row['month'],
               f"{row['income']:.2f}",
               f"{row['expenses']:.2f}",
               f"{row['net']:.2f}"
           ])
       writer.writerow([])  # Blank line
       
       # Section 2: Category Breakdown
       writer.writerow(['Category Breakdown'])
       writer.writerow(['Category', 'Amount', 'Percentage', 'Transactions'])
       for row in category_breakdown:
           writer.writerow([
               row['category'],
               f"{row['amount']:.2f}",
               f"{row['percentage']:.1f}",
               row['transaction_count']
           ])
       writer.writerow([])
       
       # Section 3: Top Categories
       writer.writerow(['Top Spending Categories'])
       writer.writerow(['Category', 'Total', 'Transactions', 'Avg per Transaction'])
       for row in top_categories:
           writer.writerow([
               row['category'],
               f"{row['amount']:.2f}",
               row['transaction_count'],
               f"{row['avg_per_transaction']:.2f}"
           ])
       
       # Create response
       output.seek(0)
       response = make_response(output.getvalue())
       response.headers['Content-Type'] = 'text/csv'
       
       # Generate filename
       date_str = datetime.now().strftime('%Y%m%d_%H%M%S')
       filename = f'financial_report_{date_str}.csv'
       response.headers['Content-Disposition'] = f'attachment; filename={filename}'
       
       return response
   ```

2. **JavaScript Export Function**:
   ```javascript
   document.getElementById('export-csv').addEventListener('click', async () => {
     const params = getFilterParams();
     window.location.href = `/reports/api/export?${params}`;
   });
   ```

3. **Add Loading State**:
   ```javascript
   document.getElementById('export-csv').addEventListener('click', async () => {
     const btn = document.getElementById('export-csv');
     btn.disabled = true;
     btn.textContent = 'Exporting...';
     
     try {
       const params = getFilterParams();
       window.location.href = `/reports/api/export?${params}`;
       
       setTimeout(() => {
         btn.disabled = false;
         btn.textContent = 'Export CSV';
       }, 2000);
     } catch (error) {
       console.error('Export failed:', error);
       alert('Failed to export data. Please try again.');
       btn.disabled = false;
       btn.textContent = 'Export CSV';
     }
   });
   ```

## Test Plan

### Integration Tests
- Test `/reports/api/export` endpoint returns CSV
- Test CSV headers are correct
- Test CSV data matches report data
- Test filtering works in export
- Test filename format is correct

### Manual Testing
1. Click "Export CSV" button
2. Verify file downloads
3. Open CSV in spreadsheet application
4. Verify all sections present and formatted correctly
5. Verify data matches charts
6. Test with filters applied
7. Test with empty data

### Success Criteria
- CSV downloads successfully
- File contains all report sections
- Data is correctly formatted (numbers, dates)
- Export respects current filters
- No errors during export
- File opens correctly in Excel/Google Sheets

## Files Modified

- `src/routes/reports.py` - Add `/api/export` endpoint
- `src/templates/reports.html` - Add export button handler
- `tests/integration/test_reports.py` - Add export tests

## Notes

- CSV should use UTF-8 encoding for compatibility
- Include metadata row at top (export date, filters used)
- Consider adding Excel export (.xlsx) as future enhancement
- Large exports (10,000+ transactions) should still complete quickly
- Add option to export raw transactions vs aggregated data

