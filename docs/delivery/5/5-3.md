# [5-3] Implement Income vs Expenses line chart

[Back to task list](./tasks.md)

## Description

Create API endpoint and frontend code to display an interactive line chart showing income vs expenses over time. This chart helps users visualize their financial health and identify trends.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-19 23:25:00 | Created | N/A | Proposed | Task file created | Saeed |

## Requirements

### Functional Requirements
1. Create API endpoint `/reports/api/income-expenses` that returns monthly data
2. Endpoint accepts optional query parameters: `account_id`, `start_date`, `end_date`
3. Return JSON with months, income values, expense values, and net values
4. Implement Chart.js line chart in reports.html
5. Chart should display:
   - Income line (green)
   - Expenses line (red)
   - Net line (blue, dashed)
   - X-axis: months
   - Y-axis: dollar amounts
6. Chart should be interactive (hover for values)
7. Update chart when filters change

### Non-Functional Requirements
- API response time < 500ms for 12 months of data
- Chart renders smoothly even with 36+ data points
- Tooltips show formatted currency ($X,XXX.XX)
- Legend clearly identifies each line
- Chart is responsive (works on mobile)

## Implementation Plan

### Step 1: Create API endpoint
Add to `src/routes/reports.py`:
```python
@reports_bp.route('/api/income-expenses')
def get_income_expenses_data():
    """Get monthly income vs expenses data"""
    account_id = request.args.get('account_id', type=int)
    start_date = request.args.get('start_date')
    end_date = request.args.get('end_date')
    
    # Parse dates
    if start_date:
        start_date = datetime.strptime(start_date, '%Y-%m-%d').date()
    if end_date:
        end_date = datetime.strptime(end_date, '%Y-%m-%d').date()
    
    # Get data from service
    report_service = ReportService(current_app.config['DATABASE'])
    data = report_service.get_monthly_income_expenses(
        account_id=account_id,
        start_date=start_date,
        end_date=end_date
    )
    
    # Format for Chart.js
    return jsonify({
        'labels': [d['month'] for d in data],
        'datasets': [
            {
                'label': 'Income',
                'data': [d['income'] for d in data],
                'borderColor': '#28a745',
                'backgroundColor': 'rgba(40, 167, 69, 0.1)',
                'tension': 0.4
            },
            {
                'label': 'Expenses',
                'data': [d['expenses'] for d in data],
                'borderColor': '#dc3545',
                'backgroundColor': 'rgba(220, 53, 69, 0.1)',
                'tension': 0.4
            },
            {
                'label': 'Net',
                'data': [d['net'] for d in data],
                'borderColor': '#007bff',
                'backgroundColor': 'rgba(0, 123, 255, 0.1)',
                'borderDash': [5, 5],
                'tension': 0.4
            }
        ]
    })
```

### Step 2: Add JavaScript chart initialization
Add to `src/templates/reports.html` `<script>` section:
```javascript
let incomeExpenseChart = null;

async function loadIncomeExpenseChart() {
    try {
        // Get filter values
        const accountId = document.getElementById('account-filter').value;
        const dateRange = document.getElementById('date-range').value;
        
        // Build query params
        const params = new URLSearchParams();
        if (accountId && accountId !== 'all') {
            params.append('account_id', accountId);
        }
        // Add date range logic here
        
        // Fetch data
        const response = await fetch(`/reports/api/income-expenses?${params}`);
        const data = await response.json();
        
        // Destroy existing chart if any
        if (incomeExpenseChart) {
            incomeExpenseChart.destroy();
        }
        
        // Create chart
        const ctx = document.getElementById('income-expense-chart').getContext('2d');
        incomeExpenseChart = new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += formatCurrency(context.parsed.y);
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading income/expense chart:', error);
        showChartError('income-expense-chart');
    }
}

// Call on page load
document.addEventListener('DOMContentLoaded', () => {
    loadIncomeExpenseChart();
});
```

### Step 3: Add helper functions
```javascript
function formatCurrency(amount) {
    return '$' + Math.abs(amount).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function showChartError(canvasId) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    ctx.font = '16px Arial';
    ctx.fillStyle = '#dc3545';
    ctx.textAlign = 'center';
    ctx.fillText('Error loading chart', canvas.width / 2, canvas.height / 2);
}
```

### Step 4: Wire up to filters
```javascript
document.getElementById('apply-filters').addEventListener('click', () => {
    loadIncomeExpenseChart();
    // Will also reload other charts in later tasks
});
```

### Step 5: Add loading state
Add to HTML:
```html
<div class="chart-card">
    <h3>Income vs Expenses</h3>
    <div class="chart-loading" id="income-expense-loading">Loading...</div>
    <canvas id="income-expense-chart" height="300"></canvas>
</div>
```

Update JavaScript to show/hide loading:
```javascript
document.getElementById('income-expense-loading').style.display = 'none';
// Show chart
```

## Test Plan

### Integration Tests
Add to `tests/integration/test_reports.py`:

1. **test_income_expenses_api_endpoint**
   - Create test transactions (income and expenses)
   - Call `/reports/api/income-expenses`
   - Assert response is 200
   - Assert JSON structure is correct
   - Assert data values match expectations

2. **test_income_expenses_api_with_account_filter**
   - Create transactions for multiple accounts
   - Call API with `account_id` parameter
   - Assert only that account's data returned

3. **test_income_expenses_api_with_date_filter**
   - Create transactions across multiple months
   - Call API with `start_date` and `end_date`
   - Assert only data in range returned

4. **test_income_expenses_api_empty_data**
   - Call API with no transactions
   - Assert empty arrays returned (not error)

### Manual Testing
1. Navigate to /reports
2. Verify chart loads and displays
3. Verify legend shows Income, Expenses, Net
4. Hover over data points, verify tooltips show correct values
5. Change account filter, verify chart updates
6. Change date range, verify chart updates
7. Test with empty database, verify graceful handling
8. Resize browser, verify chart is responsive

### Success Criteria
- API endpoint returns correct data format
- Chart displays with 3 lines (income, expenses, net)
- Chart is interactive (tooltips work)
- Chart updates when filters change
- Chart handles empty data gracefully
- No console errors
- Response time < 500ms

## Verification

### Definition of Done
- [x] API endpoint `/reports/api/income-expenses` created and working
- [x] Endpoint supports filtering by account and date range
- [x] Chart.js line chart implemented in template
- [x] Chart displays income (green), expenses (red), net (blue)
- [x] Chart is interactive with tooltips
- [x] Chart updates when filters change
- [x] Loading state shown while fetching data
- [x] Error handling for API failures
- [x] Integration tests passing (4+ tests)
- [x] Manual testing completed successfully

### Testing Evidence
- API response example JSON
- Screenshot of chart with sample data
- Integration test results
- Performance measurement (API response time)

## Files Modified

### Modified Files
- `src/routes/reports.py` - Add API endpoint
- `src/templates/reports.html` - Add chart JavaScript
- `tests/integration/test_reports.py` - Add tests

## Notes

- Use Chart.js tension: 0.4 for smooth curves
- Net line should be dashed to distinguish from income/expenses
- Consider adding a zero line on Y-axis for reference
- Tooltip should show all 3 values when hovering over a month
- If no data for a month, show 0 (not skip the month)
- Date range on X-axis should auto-format (Jan 2025, Feb 2025, etc.)

