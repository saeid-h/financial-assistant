# [5-7] Add report filters (date range and account)

[Back to task list](./tasks.md)

## Description

Implement filter controls that allow users to customize report date ranges and filter by specific accounts. All charts should update when filters are applied.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-19 23:25:00 | Created | N/A | Proposed | Task file created | Saeed |

## Requirements

### Functional Requirements
1. Implement date range selector with presets:
   - This Month
   - Last Month
   - Last 3 Months
   - Last 6 Months
   - Last 12 Months (default)
   - This Year
   - Last Year
   - Custom (show date pickers)
2. Implement account filter dropdown:
   - "All Accounts" (default)
   - List of all user accounts
3. "Apply Filters" button triggers chart refresh
4. All 4 charts update when filters applied
5. Filter state persists during session
6. Display active filter summary

### Implementation Plan

1. **HTML Filter UI**:
   ```html
   <div class="report-filters">
     <div class="filter-group">
       <label for="date-range">Date Range:</label>
       <select id="date-range">
         <option value="this-month">This Month</option>
         <option value="last-month">Last Month</option>
         <option value="last-3-months">Last 3 Months</option>
         <option value="last-6-months">Last 6 Months</option>
         <option value="last-12-months" selected>Last 12 Months</option>
         <option value="this-year">This Year</option>
         <option value="last-year">Last Year</option>
         <option value="custom">Custom Range...</option>
       </select>
     </div>
     
     <div class="filter-group" id="custom-dates" style="display: none;">
       <input type="date" id="start-date">
       <span>to</span>
       <input type="date" id="end-date">
     </div>
     
     <div class="filter-group">
       <label for="account-filter">Account:</label>
       <select id="account-filter">
         <option value="all">All Accounts</option>
         <!-- Populated dynamically -->
       </select>
     </div>
     
     <button id="apply-filters" class="btn btn-primary">Apply Filters</button>
     <button id="reset-filters" class="btn btn-secondary">Reset</button>
   </div>
   ```

2. **JavaScript Filter Logic**:
   ```javascript
   function getFilterParams() {
     const params = new URLSearchParams();
     
     // Account filter
     const accountId = document.getElementById('account-filter').value;
     if (accountId && accountId !== 'all') {
       params.append('account_id', accountId);
     }
     
     // Date range filter
     const dateRange = document.getElementById('date-range').value;
     const [startDate, endDate] = calculateDateRange(dateRange);
     if (startDate) params.append('start_date', startDate);
     if (endDate) params.append('end_date', endDate);
     
     return params;
   }
   
   function calculateDateRange(preset) {
     const today = new Date();
     let startDate, endDate;
     
     switch(preset) {
       case 'this-month':
         startDate = new Date(today.getFullYear(), today.getMonth(), 1);
         endDate = today;
         break;
       case 'last-month':
         startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
         endDate = new Date(today.getFullYear(), today.getMonth(), 0);
         break;
       case 'last-12-months':
         startDate = new Date(today.getFullYear(), today.getMonth() - 12, 1);
         endDate = today;
         break;
       // ... other cases
       case 'custom':
         startDate = document.getElementById('start-date').value;
         endDate = document.getElementById('end-date').value;
         return [startDate, endDate];
     }
     
     return [
       startDate.toISOString().split('T')[0],
       endDate.toISOString().split('T')[0]
     ];
   }
   
   function refreshAllCharts() {
     loadIncomeExpenseChart();
     loadCategoryPieChart();
     loadMonthlyCategoryChart();
     loadTopCategoriesChart();
   }
   
   document.getElementById('apply-filters').addEventListener('click', refreshAllCharts);
   ```

3. **Load Accounts**:
   ```javascript
   async function loadAccountsFilter() {
     const response = await fetch('/accounts/api/');
     const accounts = await response.json();
     
     const select = document.getElementById('account-filter');
     accounts.forEach(account => {
       const option = document.createElement('option');
       option.value = account.id;
       option.textContent = `${account.name} (${account.type})`;
       select.appendChild(option);
     });
   }
   ```

4. **Show/Hide Custom Date Inputs**:
   ```javascript
   document.getElementById('date-range').addEventListener('change', (e) => {
     const customDates = document.getElementById('custom-dates');
     customDates.style.display = e.target.value === 'custom' ? 'flex' : 'none';
   });
   ```

5. **Reset Filters**:
   ```javascript
   document.getElementById('reset-filters').addEventListener('click', () => {
     document.getElementById('date-range').value = 'last-12-months';
     document.getElementById('account-filter').value = 'all';
     document.getElementById('custom-dates').style.display = 'none';
     refreshAllCharts();
   });
   ```

## Test Plan

### Integration Tests
- Test date range calculations for each preset
- Test custom date range
- Test account filtering
- Test "Apply Filters" refreshes all charts
- Test "Reset" returns to defaults

### Manual Testing
1. Select different date ranges, verify charts update
2. Select specific account, verify only that account's data shown
3. Try custom date range
4. Reset filters, verify back to defaults
5. Test with no data in selected range
6. Test filter persistence during session

## Files Modified

- `src/templates/reports.html` - Add filter UI and JavaScript
- `src/static/css/style.css` - Style filter controls
- `tests/integration/test_reports.py` - Add filter tests

## Notes

- Store filter state in sessionStorage for persistence
- Add visual indicator showing active filters
- Disable "Apply" button if custom dates are invalid
- Consider adding "Export with current filters" feature

