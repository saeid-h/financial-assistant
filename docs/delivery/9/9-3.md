# Task 9-3: Recurring Transaction Management Service

[Back to task list](./tasks.md)

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-19 07:05:00 | Created | N/A | Proposed | Task file created | Saeed |
| 2025-10-19 07:05:00 | Status Update | Proposed | Agreed | Task approved for implementation | Saeed |
| 2025-10-19 07:05:00 | Status Update | Agreed | InProgress | Starting implementation | Saeed |

## Description

Create a management service for CRUD operations on recurring transactions, retrieving active/upcoming items, generating alerts for missing or changed payments, and updating instances when new transactions are imported.

## Requirements

### Service Methods

**CRUD Operations:**
- `get_by_id(recurring_id)` - Get single recurring transaction
- `get_all(status=None)` - Get all/filtered recurring transactions
- `get_active()` - Get only active recurring transactions
- `create(pattern_data)` - Create new recurring transaction
- `update(recurring_id, updates)` - Update recurring transaction
- `delete(recurring_id)` - Delete recurring transaction
- `pause(recurring_id)` - Pause tracking
- `resume(recurring_id)` - Resume tracking

**Query Methods:**
- `get_upcoming(days=30)` - Get expected transactions in next N days
- `get_by_category(category_id)` - Get recurring transactions by category
- `get_monthly_total()` - Calculate total monthly recurring expenses

**Alert Generation:**
- `get_missing_payments(days_overdue=3)` - Find missed payments
- `get_amount_changes(variance_threshold=0.10)` - Find amount changes
- `get_all_alerts()` - Get all alerts (missing + changed)

**Instance Management:**
- `add_instance(recurring_id, transaction_id, status)` - Link transaction to pattern
- `update_instance_status(instance_id, status)` - Update instance status
- `get_instances(recurring_id)` - Get all instances for a recurring transaction

## Implementation Plan

1. Create `src/services/recurring_manager.py`
2. Implement CRUD operations with proper validation
3. Implement query methods for upcoming and filtered results
4. Implement alert generation logic:
   - Check if next_expected_date < today - days_overdue
   - Check if last instance amount variance > threshold
5. Implement instance management for linking transactions
6. Add helper methods for calculations (monthly total, etc.)
7. Handle edge cases (deleted categories, deleted transactions)

## Test Plan

**Objective**: Verify management service operations work correctly

**Test Scenarios:**

1. **CRUD Operations**:
   - Create recurring transaction
   - Retrieve by ID
   - Update fields (name, amount, frequency)
   - Delete recurring transaction
   - Pause/Resume status changes

2. **Query Methods**:
   - Get upcoming transactions (next 7, 30, 90 days)
   - Filter by status (active only)
   - Filter by category
   - Calculate monthly total

3. **Alert Generation**:
   - Missing payment detection (3+ days overdue)
   - Amount change detection (>10% variance)
   - Combined alert list

4. **Instance Management**:
   - Add instance for new transaction
   - Update instance status
   - Get instance history for recurring item

**Success Criteria:**
- All CRUD operations work correctly
- Queries return accurate filtered results
- Alerts generated for missing/changed payments
- Instance tracking works properly
- Unit tests pass

## Verification

- [ ] Service created with all methods
- [ ] CRUD operations work
- [ ] Query methods return correct data
- [ ] Alert generation accurate
- [ ] Instance management functional
- [ ] Unit tests pass (20+ tests)

## Files Modified

- `src/services/recurring_manager.py` (NEW)
- `tests/unit/test_recurring_manager.py` (NEW)


