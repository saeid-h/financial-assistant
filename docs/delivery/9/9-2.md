# Task 9-2: Recurring Transaction Detection Service

[Back to task list](./tasks.md)

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-19 07:00:00 | Created | N/A | Proposed | Task file created | Saeed |
| 2025-10-19 07:00:00 | Status Update | Proposed | Agreed | Task approved for implementation | Saeed |
| 2025-10-19 07:00:00 | Status Update | Agreed | InProgress | Starting implementation | Saeed |

## Description

Implement the core pattern detection algorithm that identifies recurring transactions from historical data. The service will analyze transactions to find similar descriptions occurring at regular intervals with consistent amounts.

## Requirements

### Detection Algorithm

**Similarity Matching:**
- Fuzzy description matching (85%+ similarity using Levenshtein distance)
- Case-insensitive comparison
- Handle merchant name variations (NETFLIX vs Netflix.com)

**Frequency Detection:**
- Weekly: 7 days ± 2 days
- Bi-weekly: 14 days ± 3 days
- Monthly: 28-31 days ± 3 days
- Quarterly: 90 days ± 7 days
- Annual: 365 days ± 14 days

**Amount Consistency:**
- Exact: Same amount every time
- Similar: Within ±10% variance
- Calculate average and variance

**Minimum Occurrences:**
- Require 3+ matching transactions
- At least 2 intervals to establish pattern

### Service Methods

- `detect_patterns(account_id=None)` - Scan all transactions for patterns
- `is_similar_description(desc1, desc2)` - Check if descriptions match
- `calculate_frequency(dates)` - Determine interval pattern
- `is_consistent_amount(amounts, tolerance=0.10)` - Check amount consistency
- `create_recurring_pattern(matches)` - Save detected pattern to database

## Implementation Plan

1. Install required package: `pip install python-Levenshtein`
2. Create `src/services/recurring_detector.py`
3. Implement similarity matching using Levenshtein distance
4. Implement frequency calculation from date intervals
5. Implement amount consistency check
6. Implement main detection algorithm
7. Add confidence scoring (0.0-1.0)
8. Handle edge cases (irregular patterns, outliers)

## Test Plan

**Objective**: Verify pattern detection works accurately

**Test Scenarios:**

1. **Perfect Monthly Pattern**:
   - Netflix: $15.99 on 1st of each month (3 months)
   - Expected: Detected as monthly, confidence >0.90

2. **Variable Amount Pattern**:
   - Electric bill: $85, $92, $88 (monthly, ±10%)
   - Expected: Detected as monthly with variance

3. **Irregular Interval**:
   - Random purchases: different dates, different amounts
   - Expected: NOT detected (too irregular)

4. **Similar But Not Same**:
   - Costco: Weekly visits, varying amounts
   - Expected: NOT detected (amount variance too high)

5. **Minimum Occurrences**:
   - 2 instances only
   - Expected: NOT detected (need 3+)

**Success Criteria:**
- Detects clear monthly patterns (Netflix, Spotify)
- Handles amount variance (utilities)
- Rejects irregular patterns
- Calculates correct frequency
- Confidence score reflects pattern strength

## Verification

- [ ] Service created with all methods
- [ ] Levenshtein distance working
- [ ] Frequency detection accurate
- [ ] Amount variance calculation correct
- [ ] Main detection algorithm works
- [ ] Unit tests pass

## Files Modified

- `requirements.txt` (add python-Levenshtein)
- `src/services/recurring_detector.py` (NEW)
- `tests/unit/test_recurring_detector.py` (NEW)


