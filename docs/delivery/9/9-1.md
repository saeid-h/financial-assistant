# Task 9-1: Database Schema for Recurring Transactions

[Back to task list](./tasks.md)

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-19 06:58:00 | Created | N/A | Proposed | Task file created | Saeed |
| 2025-10-19 06:58:00 | Status Update | Proposed | Agreed | Task approved for implementation | Saeed |
| 2025-10-19 06:58:00 | Status Update | Agreed | InProgress | Starting implementation | Saeed |

## Description

Create database schema for tracking recurring transactions (subscriptions, bills, regular payments) and their instances. This includes two tables: `recurring_transactions` for the recurring pattern and `recurring_transaction_instances` for tracking each occurrence.

## Requirements

### Database Tables

**Table 1: recurring_transactions**
- Stores detected recurring patterns
- Fields: id, merchant_name, description_pattern, frequency, average_amount, amount_variance, category_id, last_transaction_date, next_expected_date, status, alert flags, timestamps
- Supports 5 frequency types: weekly, biweekly, monthly, quarterly, annual

**Table 2: recurring_transaction_instances**
- Tracks each occurrence of a recurring transaction
- Links to parent recurring_transaction and actual transaction
- Fields: id, recurring_id, transaction_id, expected/actual date and amount, variance, status
- Supports status tracking: on_time, late, missed, amount_changed

### Migration Script

- Check if tables already exist before creating
- Handle errors gracefully
- Provide clear success/error messages
- Be idempotent (safe to run multiple times)

## Implementation Plan

1. Create migration script: `src/migrate_add_recurring_transactions.py`
2. Define both table schemas with proper constraints
3. Add foreign key relationships
4. Add CHECK constraints for enums
5. Run migration to create tables
6. Verify tables created successfully

## Test Plan

**Objective**: Verify database schema is created correctly

**Tests**:
1. Migration script runs without errors
2. Both tables exist in database
3. Tables have correct columns and types
4. Foreign key constraints are defined
5. CHECK constraints work for enums
6. Migration is idempotent (can run twice safely)

**Success Criteria**:
- Migration completes successfully
- All columns present with correct types
- Constraints enforced properly
- No errors when inserting valid data

## Verification

- [ ] Migration script created
- [ ] Tables created in database
- [ ] Foreign keys working
- [ ] CHECK constraints enforced
- [ ] Can insert sample recurring transaction
- [ ] Can insert sample instance

## Files Modified

- `src/migrate_add_recurring_transactions.py` (NEW)
- `data/financial_assistant.db` (schema updated)


